---
layout:     post                    # ä½¿ç”¨çš„å¸ƒå±€ï¼ˆä¸éœ€è¦æ”¹ï¼‰
title:      ğŸš€é«˜æ€§èƒ½Tornadoå¤„ç†é€»è¾‘å®ç°	# æ ‡é¢˜
subtitle:  Use Tornado like a pro 	 #å‰¯æ ‡é¢˜
date:       2021-12-17              # æ—¶é—´
author:     Wh1isper                      # ä½œè€…
banner_img: /img/post-bg-unix-linux.jpg    #æŠ€æœ¯åˆ†äº«-ç¼–ç¨‹
catalog: true                       # æ˜¯å¦å½’æ¡£
category:
    # - éšç¬”
    # - æ—¶è¯„
    # - è¯»ä¹¦ç¬”è®°
    - æŠ€æœ¯åˆ†äº«
tags:                               #æ ‡ç­¾
    - Tornado
    - Python
    - å¼‚æ­¥
    - é«˜æ€§èƒ½
    - åç¨‹
---
# å‰è¨€

å¤§å¤šæ•°äººéƒ½çŸ¥é“Tornadoæ˜¯ä¸€ä¸ªåç¨‹å¼‚æ­¥æ¡†æ¶ï¼Œä½†æ˜¯å¤§å¤šæ•°äººéƒ½æ²¡æœ‰å¾ˆå¥½çš„ç†è§£åç¨‹ç¼–ç¨‹çš„ç›¸å…³åŸç†ï¼Œç½‘ä¸Šä¹Ÿç¼ºä¹ç›¸å…³çš„æ•™ç¨‹ï¼Œå¾€å¾€æµ…å°è¾„æ­¢ã€‚

è¿™ç¯‡æ–‡ç« å°†è¯•ç€ä»ç›˜å¤å¼€å¤©è¯´èµ·ï¼Œå°†ä¸€ä¸ªhello worldæœåŠ¡å™¨å˜æˆä¸€ä¸ªæµ·é‡ååæœåŠ¡å™¨ï¼Œé€‚åˆåç¨‹ç¼–ç¨‹å…¥é—¨çš„æ–°æ‰‹ï¼Œå¯¹åç¨‹æœ‰å…´è¶£ï¼Œä½†æ˜¯å¯¹åç¨‹åŸç†ä¸€çŸ¥åŠè§£çš„åŒå­¦é˜…è¯»ï¼›ä¹Ÿé€‚åˆä½¿ç”¨Djangoç­‰çº¿ç¨‹æ¨¡å‹æœåŠ¡å™¨çš„å¼€å‘åŒå­¦äº†è§£Tornadoæ˜¯å¦‚ä½•åŒæ—¶è·å¾—åç¨‹å’Œå¤šè¿›ç¨‹ä¼˜åŠ¿çš„ã€‚

**TL;DR;ä½ å¯ä»¥ç›´æ¥è·³åˆ°æœ€åé¢çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹é˜…è¯»ä»£ç ï¼Œçœå»å‰é¢çš„ç®€å•å†…å®¹ã€‚**

å½“ç„¶ï¼ŒTornadoå¤šè¿›ç¨‹æ¨¡å¼éœ€è¦ä¾èµ–forkå‡½æ•°ï¼Œåœ¨windowsä¸Šæ˜¯è¡Œä¸é€šçš„ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€æœ¬ç¯‡æ–‡ç« çš„ä»£ç éƒ½æ— æ³•è¿è¡Œï¼Œç›¸åï¼Œä½ åªéœ€è¦æ³¨é‡Šæ‰ `http_server.start(0)`ï¼Œå°±å¯ä»¥è¿è¡Œæœ¬ç¯‡æ–‡ç« çš„æ‰€æœ‰ä»£ç ã€‚åœ¨æœ€ç»ˆç‰ˆæœ¬ä¸­ï¼Œæœ¬æ–‡å®ç°äº†ä¸€ä¸ªå…¨å¼‚æ­¥çš„æœåŠ¡ï¼Œå³ä½¿ä½ æ— æ³•å¯åŠ¨å¤šè¿›ç¨‹çš„Tornadoï¼Œç›¸ä¿¡æˆ‘ï¼Œè¿™ä¹Ÿä¸ä¼šæˆä¸ºä½ çš„æ€§èƒ½ç“¶é¢ˆï¼

å®Œæˆè¿™ç¯‡æ–‡ç« ä¸»è¦é ç¬”è€…çš„é˜…è¯»ç»éªŒå’Œå®é™…é¡¹ç›®ç»éªŒï¼Œã€Šæµç•…çš„Pythonã€‹ä¸€ä¹¦å¯¹å¦‚ä½•æ”¹é€ çº¿ç¨‹æ¨¡å‹ä¸ºåç¨‹æ¨¡å‹æœ‰è¯¦ç»†çš„ä»‹ç»ï¼Œå¦‚æœæƒ³è¦æ·±å…¥å­¦ä¹ Pythonï¼Œå»ºè®®é˜…è¯»æ­¤ä¹¦ã€‚æœ¬æ–‡å€Ÿç”¨å…¶åŸåˆ™ï¼šä»æŸä¸ªå‡½æ•°è¿›è¡Œæ”¹é€ æ—¶ï¼Œé¦–å…ˆå°†å…¶å®šä¹‰ä¸º `async`çš„ï¼Œå…¶æ¬¡å°†å…¶ä¸­çš„è€—æ—¶æ“ä½œåˆ©ç”¨ `run_in_executor`å°è£…ï¼Œæœ€åå±‚å±‚æ”¹è¿›å…¶è°ƒç”¨å‡½æ•°ï¼Œä½¿ç”¨ `await`è°ƒç”¨ï¼Œåœ¨è¿™é‡Œå¬ä¸æ‡‚æ²¡å…³ç³»ï¼Œåé¢ä¼šæœ‰å®é™…è®²è§£

# ä»Hello World!å¼€å§‹

é¦–å…ˆæˆ‘ä»¬ä»Hello worldå¼€å§‹ï¼Œç¨ç¨ä¿®æ”¹äº†å®˜æ–¹ç»™å‡ºçš„ä¾‹å­ï¼Œå¾—åˆ°äº†ä¸€ä¸ªæ¥å—ä¸æ˜¯å¾ˆè§„èŒƒçš„getå®ç°ï¼Œè§£æè¯·æ±‚çš„ `json` bodyå¯¹è±¡ï¼Œä»ä¸­è¯»å– `job_id`å¹¶è¾“å‡ºçš„æœåŠ¡

```python
import logging

import tornado.httpserver
import tornado.ioloop
import tornado.options
import tornado.web
import json

from tornado.options import define, options

define("port", default=8888, help="run on the given port", type=int)


def get_logger():
    return logging.getLogger("tornado.general")


class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()

    def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        self.do_something(job_id)
        self.write(f"{job_id} done")

    def do_something(self, job_id):
        self.logger.info(f'do job:{job_id}')


def main():
    tornado.options.parse_command_line()
    application = tornado.web.Application([(r"/", MainHandler)])
    http_server = tornado.httpserver.HTTPServer(application)
    http_server.listen(options.port)
    # å¤šè¿›ç¨‹
    # http_server.start(0)
    tornado.ioloop.IOLoop.current().start()


if __name__ == "__main__":
    main()

```

å¯åŠ¨åï¼Œä»–ä¼šç›‘å¬ä½ çš„8888ç«¯å£

## å†™ä¸ªç®€å•çš„è¯·æ±‚è„šæœ¬å§

ä¸‹é¢æˆ‘ä»¬ç®€å•çš„å†™ä¸ªè¯·æ±‚è„šæœ¬éªŒè¯ä¸€ä¸‹

```python
import requests
import json

from requests import Timeout

def api_request(job_id):
    try:
        response = requests.get('http://localhost:8888', data=json.dumps({'job_id': job_id}), timeout=3) # ç‰¹æ„è®¾ç½®äº†3ç§’è¶…æ—¶
    except Timeout:
        return False
    return response.status_code == 200
if __name__ == '__main__':
    api_request(1)
```

è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼Œä½ å°±å‘ä½ çš„æœåŠ¡å™¨å‘é€äº†ä¸€ä¸ªgetè¯·æ±‚å•¦

ä¹‹åæˆ‘ä»¬ä¼šé’ˆå¯¹è¿™ä¸ªè„šæœ¬è¿›è¡Œæ‰©å±•ï¼Œä»¥è¾¾åˆ°å¹¶å‘æµ‹è¯•çš„ç›®çš„~

# å¦‚æœä»»åŠ¡æ—¶é—´æ¯”è¾ƒé•¿æ€ä¹ˆåŠï¼Ÿ

å®é™…çš„å¼€å‘ä¸­ï¼Œä¸å¯èƒ½ç®€å•çš„æ‰“ä¸ªæ—¥å¿—å°±ç»“æŸï¼Œä¸‡ä¸€æ˜¯ä¸€ä¸ªéœ€è¦ä¸€äº›æ—¶é—´ï¼ˆæ¯”å¦‚1sï¼Ÿ0.5sï¼Ÿï¼‰æ‰èƒ½å®Œæˆçš„ä»»åŠ¡ï¼Œé‚£ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ

```python
...
#çœç•¥äº†ä¸€äº›ä½ å·²ç»çŸ¥é“çš„ä¾èµ–å¼•å…¥
import time

class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()

    def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        self.do_something(job_id)
        self.write(f"{job_id} done")

    def do_something(self, job_id):
        # æ¨¡æ‹Ÿä¸€ä¸ªä»»åŠ¡éœ€è¦1ç§’çš„æ—¶é—´å®Œæˆ
        time.sleep(1)
        self.logger.info(f'job done:{job_id}')
...
#çœç•¥äº†æœåŠ¡å™¨å¯åŠ¨çš„ä»£ç 
```

åœ¨ä»¥ä¸Šçš„ä»£ç ä¸­ï¼Œ`time.sleep(1)`å°†é˜»å¡æœåŠ¡å™¨ï¼Œè¿™å¹¶ä¸æ„å‘³ç€æ— æ³•å»ºç«‹è¿æ¥ï¼Œä½†æ˜¯ä¼šå¯¼è‡´å·²ç»å»ºç«‹çš„è¿æ¥æ— æ³•æ”¶åˆ°æ¶ˆæ¯ï¼Œå½¢æˆ `ReadTimeout`

## æ¨¡æ‹Ÿå¹¶å‘æµ‹è¯•

è®©æˆ‘ä»¬æŠŠä¹‹å‰çš„è¯·æ±‚è„šæœ¬æ”¹ä¸€æ”¹ï¼Œå˜ä¸ºä¸€ä¸ªå¹¶å‘æµ‹è¯•çš„è„šæœ¬

```python
import requests
import json
from multiprocessing import Pool

from requests import Timeout

# æ€»è¯·æ±‚æ•°
REQUEST_NUM = 10
# è¿›ç¨‹æ•°
PROCESSOR_NUM = 10


def api_request(job_id):
    try:
        response = requests.get('http://localhost:8888', data=json.dumps({'job_id': job_id}), timeout=3)
    except Timeout:
        return False
    return response.status_code == 200


if __name__ == '__main__':
    with Pool(PROCESSOR_NUM) as p:
        result = p.map(api_request, range(REQUEST_NUM))
    succeed = result.count(True)
    failed = result.count(False)
    print(f"{succeed / (failed + succeed) * 100}% request success!")

```

è¿è¡Œè„šæœ¬ï¼Œä½ ä¼šå¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

```bash
20.0% request success!
```

è€Œåœ¨æœåŠ¡å™¨ç«¯çš„æ—¥å¿—ï¼Œä½ ä¼šçœ‹åˆ°å®é™…ä¸Šæ˜¯æœ‰10ä¸ªè¯·æ±‚çš„

```bash
[I 211217 23:45:52 hello_world:29] job done:0
[I 211217 23:45:52 web:2239] 200 GET / (::1) 1012.00ms
[I 211217 23:45:53 hello_world:29] job done:1
[I 211217 23:45:53 web:2239] 200 GET / (::1) 2025.00ms
[I 211217 23:45:54 hello_world:29] job done:2
[I 211217 23:45:54 web:2239] 200 GET / (::1) 3032.00ms
[I 211217 23:45:55 hello_world:29] job done:3
[I 211217 23:45:55 web:2239] 200 GET / (::1) 1009.00ms
[I 211217 23:45:56 hello_world:29] job done:4
[I 211217 23:45:56 web:2239] 200 GET / (::1) 2020.00ms
[I 211217 23:45:57 hello_world:29] job done:5
[I 211217 23:45:57 web:2239] 200 GET / (::1) 3029.00ms
[I 211217 23:45:58 hello_world:29] job done:6
[I 211217 23:45:58 web:2239] 200 GET / (::1) 4044.00ms
[I 211217 23:45:59 hello_world:29] job done:8
[I 211217 23:45:59 web:2239] 200 GET / (::1) 5056.00ms
[I 211217 23:46:00 hello_world:29] job done:7
[I 211217 23:46:00 web:2239] 200 GET / (::1) 6068.00ms
[I 211217 23:46:01 hello_world:29] job done:9
[I 211217 23:46:01 web:2239] 200 GET / (::1) 7076.00ms

```

è¿™è¯´æ˜ï¼Œè¿™åä¸ªè¿æ¥è¢«Tornadoâ€æ¥ä½â€œäº†ï¼Œå»ºç«‹äº†è¿æ¥ï¼Œä½†æ˜¯clientç«¯è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶åclientç«¯æ–­å¼€äº†è¿æ¥ï¼Œè€Œä»æ ¹æ®3ç§’è¶…æ—¶ï¼Œ1ç§’å¤„ç†æ—¶é—´æ¥çœ‹ï¼Œåªæœ‰å‰ä¸¤ä¸ªè¯·æ±‚æœ‰å¯èƒ½å®Œæˆï¼Œç¬¬ä¸‰ä¸ªè¯·æ±‚å¤§æ¦‚ç‡è¶…æ—¶ï¼Œç¬¬ä¸‰ä¸ªä¹‹åçš„è¯·æ±‚æ ¹æœ¬ä¸ç”¨æƒ³ï¼Œå¿…å®šè¶…æ—¶

# ä½¿ç”¨å¤šè¿›ç¨‹æ¥æ”¶è¯·æ±‚

æ¥è§¦è¿‡djangoã€flaskè¿™ç±»çº¿ç¨‹æ¨¡å‹çš„webæ¡†æ¶çš„ä½ å¯èƒ½ä¼šæƒ³åˆ°ä½¿ç”¨å¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹æ¥å¤„ç†ï¼ŒTornadoä½œä¸ºåç¨‹æ¡†æ¶ï¼Œæä¾›æœ‰å¤šè¿›ç¨‹çš„æ¥å£ï¼Œåªéœ€è¦æ‰“å¼€ `http_server.start(0)`æ³¨é‡Šï¼Œä½ å°±ä¼šå¾—åˆ°å¤šè¿›ç¨‹çš„TornadoæœåŠ¡

```python
def main():
    tornado.options.parse_command_line()
    application = tornado.web.Application([(r"/", MainHandler)])
    http_server = tornado.httpserver.HTTPServer(application)
    http_server.listen(options.port)
    # å¤šè¿›ç¨‹ï¼Œæ ¹æ®ä½ çš„CPUæ ¸æ•°å†³å®š
    http_server.start(0)
    tornado.ioloop.IOLoop.current().start()
```

ç„¶åæˆ‘ä»¬å†è¿›è¡Œä¸€æ¬¡è¯·æ±‚ï¼Œå¾—åˆ°çš„æœåŠ¡å™¨æ—¥å¿—å¦‚ä¸‹ï¼š

```bash
[I 211218 00:03:09 process:123] Starting 8 processes
[I 211218 00:03:12 hello:29] job done:0
[I 211218 00:03:12 web:2239] 200 GET / (127.0.0.1) 1002.04ms
[I 211218 00:03:12 hello:29] job done:5
[I 211218 00:03:12 web:2239] 200 GET / (127.0.0.1) 1002.93ms
[I 211218 00:03:12 hello:29] job done:8
[I 211218 00:03:12 hello:29] job done:4
[I 211218 00:03:12 web:2239] 200 GET / (127.0.0.1) 1002.39ms
[I 211218 00:03:12 web:2239] 200 GET / (127.0.0.1) 1002.52ms
[I 211218 00:03:12 hello:29] job done:9
[I 211218 00:03:12 hello:29] job done:7
[I 211218 00:03:12 web:2239] 200 GET / (127.0.0.1) 1002.65ms
[I 211218 00:03:12 web:2239] 200 GET / (127.0.0.1) 1002.69ms
[I 211218 00:03:12 hello:29] job done:6
[I 211218 00:03:12 web:2239] 200 GET / (127.0.0.1) 1002.06ms
[I 211218 00:03:13 hello:29] job done:2
[I 211218 00:03:13 web:2239] 200 GET / (127.0.0.1) 2002.96ms
[I 211218 00:03:14 hello:29] job done:1
[I 211218 00:03:14 web:2239] 200 GET / (127.0.0.1) 3005.87ms
[I 211218 00:03:15 hello:29] job done:3
[I 211218 00:03:15 web:2239] 200 GET / (127.0.0.1) 4007.62ms

```

è¿™æ¬¡æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸäº†ï¼ï¼ˆå¦‚æœæœ‰å¤±è´¥çš„ï¼Œä½ å½“ç„¶å¯ä»¥å¤šè¯•å‡ æ¬¡ï¼‰

```bash
100.0% request success!
```

å½“ç„¶ï¼Œè¿™ç§ç®€å•ç²—æš´çš„æ–¹å¼æœ‰å…¶ç¼ºç‚¹ï¼š

1. èµ„æºæ¶ˆè€—å¤§ï¼Œæ¯ä¸ªè¿æ¥éƒ½éœ€è¦ä¸€ä¸ªè¿›ç¨‹ä¿æŒ
2. stupidï¼Œå°±åƒçŸ¥ä¹ä¸Šçš„å…¥é—¨æ•™ç¨‹ä¸€æ ·ï¼Œæ²¡å¬è¯´è¿‡ä»€ä¹ˆæ˜¯åç¨‹
3. å¤šè¿›ç¨‹éœ€è¦è€ƒè™‘ç«äº‰ï¼ŒåŠ é”ï¼Œå¯èƒ½1æ ¸æœ‰éš¾7æ ¸å›´è§‚

# åƒä¸ªèªæ˜äººï¼šä½¿ç”¨åç¨‹

å®é™…ä¸Šï¼Œæˆ‘ä»¬åªè¦ä½¿ç”¨Tornadoçš„å¼‚æ­¥ç‰¹æ€§ï¼Œä¸éœ€è¦å¤šè¿›ç¨‹ï¼Œå°±å¯ä»¥æå®šè¿™ä¸ªé—®é¢˜

æˆ‘æŠŠè§£å†³é—®é¢˜çš„æ­¥éª¤éƒ½æ ‡æ³¨åœ¨æ³¨é‡Šé‡Œï¼Œå¸Œæœ›ä½ èƒ½ç†è§£è‡ªåº•å‘ä¸Šå¼‚æ­¥æ”¹é€ çš„æµç¨‹

```python
# 0.å¼‚æ­¥å®ç°çš„åº“
import asyncio
class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()

    # 4.æŠŠè¿™ä¸ªå‡½æ•°ä¹Ÿå˜æˆå¼‚æ­¥çš„ï¼Œç„¶åç»§ç»­å‘ä¸Šå˜æ›´ï¼Œä¸Šçº§Tornado Handleræ”¯æŒå¼‚æ­¥çš„getè¯·æ±‚ï¼Œä¿®æ”¹åˆ°æ­¤ä¸ºæ­¢
    async def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        # 3.æŠŠdo_somethingçš„è°ƒç”¨å˜æˆå¼‚æ­¥è°ƒç”¨
        await  self.do_something(job_id)
        self.write(f"{job_id} done")

    # 2.æŠŠè¿™ä¸ªå‡½æ•°ç¼–ç¨‹å¼‚æ­¥çš„
    async def do_something(self, job_id):
        # 1.ä½¿ç”¨å¼‚æ­¥å®ç°çš„åº“æ›¿æ¢è€—æ—¶æ“ä½œ
        await asyncio.sleep(1)
        self.logger.info(f'job done:{job_id}')
```

ç°åœ¨è®©æˆ‘ä»¬æ³¨é‡Šæ‰å¤šè¿›ç¨‹æ¨¡å¼

```python
# å…³æ‰å¤šè¿›ç¨‹ï¼Œåƒä¸ªç”·å­æ±‰
# http_server.start(0)
```

ç„¶åæµ‹è¯•ä¸€ä¸‹åˆšæ‰çš„è„šæœ¬

```bash
[I 211218 00:08:17 hello:29] job done:2
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1003.32ms
[I 211218 00:08:17 hello:29] job done:0
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1002.62ms
[I 211218 00:08:17 hello:29] job done:3
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1002.47ms
[I 211218 00:08:17 hello:29] job done:1
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1002.51ms
[I 211218 00:08:17 hello:29] job done:4
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1002.49ms
[I 211218 00:08:17 hello:29] job done:7
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1002.37ms
[I 211218 00:08:17 hello:29] job done:8
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1002.94ms
[I 211218 00:08:17 hello:29] job done:6
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1002.41ms
[I 211218 00:08:17 hello:29] job done:9
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1003.31ms
[I 211218 00:08:17 hello:29] job done:5
[I 211218 00:08:17 web:2239] 200 GET / (127.0.0.1) 1003.20ms
```

èŠœæ¹–ï¼Œæ‰€æœ‰è¿æ¥éƒ½åœ¨1ç§’å·¦å³æå®šäº†ï¼

## åç¨‹çš„åŸç†

å¯¹äºåˆå­¦è€…è€Œè¨€ï¼Œä½ é¦–å…ˆéœ€è¦äº†è§£ç”¨æˆ·çº§çº¿ç¨‹å’Œå†…æ ¸çº§çº¿ç¨‹çš„åŒºåˆ«ã€‚åç¨‹å®é™…ä¸Šæ˜¯ä¸€ä¸ªå•è¿›ç¨‹å•çº¿ç¨‹æ¨¡å‹ï¼Œå¯¹äºå†…æ ¸è€Œè¨€ï¼Œå®ƒæ˜¯1è€ŒéNï¼Œåç¨‹ç¨‹åºè‡ªå·±æ§åˆ¶å„ä¸ªåç¨‹ä¹‹é—´çš„è¿è¡Œé¡ºåºï¼Œè¿™å°±æ˜¯ç”¨æˆ·çº§çº¿ç¨‹ã€‚ä¸è°ˆå†…æ ¸æ˜¯å¦‚ä½•è°ƒåº¦çº¿ç¨‹çš„ï¼Œå¯¹äºåç¨‹è€Œè¨€ï¼Œæ¯ä¸ª `await`éƒ½ä»£è¡¨ç€è®©å‡ºç¨‹åºæ§åˆ¶ï¼ˆè®©å‡ºCPUï¼‰ï¼Œå¹¶å°†ç»“æœåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œåç¨‹è°ƒåº¦å™¨å°†ä»ç­‰å¾…é˜Ÿåˆ—ä¸­æ‰¾åˆ°ä¸€ä¸ªå·²ç»å®Œæˆçš„ä»»åŠ¡ï¼Œæ¢å¤å…¶ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œè®©è¿™ä¸ªä»»åŠ¡èƒ½å¤Ÿç»§ç»­æ‰§è¡Œä¸‹å»ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ1ç§’ä¹‹åï¼Œ`asyncio.sleep(1)`çš„ä»»åŠ¡å®Œæˆäº†ï¼Œè¿™æ—¶å¦‚æœæœ‰å¥½å¿ƒäººèƒ½å¤Ÿè®©å‡ºCPUï¼ˆè°ƒç”¨ `await`ï¼‰ï¼Œé‚£ä¹ˆåŸæ¥æš‚åœçš„ç¨‹åºå°±æœ‰å¯èƒ½è¢«é€‰ä¸­ï¼Œå¾—ä»¥ç»§ç»­å®Œæˆã€‚

åç¨‹å°±æ˜¯è¿™æ ·ï¼Œåœ¨å•çº¿ç¨‹ä¸­å¾ªç¯æœç´¢é‚£äº›å·²ç»å®Œæˆçš„ä»»åŠ¡å¹¶åŠ ä»¥æ¨è¿›ï¼ŒåŒæ—¶ç­‰å¾…ã€ç®¡ç†é‚£äº›æœªå®Œæˆçš„ä»»åŠ¡

è¿™æ ·ä¸€è¯´ï¼Œå¸Œæœ›ä½ èƒ½ç†è§£ `IOLoop`ä¸­ `Loop`è¿™å››ä¸ªå­—æ¯çš„å«ä¹‰

## åç¨‹çš„é—®é¢˜

ä½ ä¹Ÿçœ‹åˆ°äº†ï¼Œåç¨‹æœ€é‡è¦çš„æ˜¯ç­‰å¾…ä»»åŠ¡å®Œæˆï¼Œä½†æ²¡æœ‰å‘Šè¯‰æˆ‘ä»¬ä»»åŠ¡å¦‚ä½•å®Œæˆ

å¦‚æœä»»åŠ¡æ˜¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚ï¼Œé‚£ä¹ˆç­‰å¾…ä»–å®Œæˆæ˜¯ä¸€ä»¶æŒºä¸é”™çš„äº‹ï¼Œä½†å¦‚æœä»»åŠ¡æ˜¯æ‰“å°ä¸€è¡Œæ—¥å¿—ï¼Œé‚£ä¹ˆç­‰å¾…ä»–å®Œæˆå°±æ˜¾å¾—æœ‰ç‚¹è ¢

å…¶å®å¯¹äºç¨‹åºå‘˜æ¥è¯´ï¼Œæœ€é‡è¦çš„äº‹æœ‰åº“å¯ä»¥**å¼‚æ­¥**åœ°åšäº‹

å¦åˆ™ï¼Œä½ å°±å¾—å‚è€ƒä¸‹ä¸€ç« ï¼Œä½¿ç”¨executorå°è£…äº†

## ä½¿ç”¨executorå°è£…åç¨‹

å¦‚ä½•åœ¨ä¸è€—è´¹CPUçš„æƒ…å†µä¸‹åšä¸€ä»¶è€—è´¹CPUçš„äº‹ï¼Ÿè¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªæ‚–è®ºã€‚

å› æ­¤ï¼Œå¯¹äºä¸€äº›éœ€è¦è®¡ç®—ï¼Œæˆ–è€…æ²¡æœ‰å¼‚æ­¥å®ç°çš„ä»»åŠ¡æ¥è¯´ï¼Œæƒ³è¦åƒ `asyncio.sleep()`ä¸€æ ·è½»æ¾å¼‚æ­¥æ‰§è¡Œæ˜¯åšä¸åˆ°çš„ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬å€ŸåŠ©çº¿ç¨‹æˆ–è¿›ç¨‹çš„åŠ›é‡ï¼ˆ**å½“ç„¶ï¼Œçº¿ç¨‹å®‰å…¨å°±æ˜¯é¿ä¸å¼€çš„è¯é¢˜**ï¼‰ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å‡è£…å¿˜è®° `sleep`çš„å¼‚æ­¥å®ç°ï¼Œæ¢å› `time.sleep()`ç„¶åä½ å°±ä¼šå‘ç°ï¼Œ`async`å¹¶ä¸èƒ½è®©ä½ è·å¾—å¼‚æ­¥çš„èƒ½åŠ›ï¼Œè€Œæ˜¯åƒæ™®é€šå‡½æ•°ä¸€æ ·å¡æ­»åœ¨è¿™é‡Œ

```python
import time
class MainHandler(tornado.web.RequestHandler):
    async def do_something(self, job_id):
        # å“¦ï¼Œæˆ‘ä»¬åœ¨å¼‚æ­¥å‡½æ•°é‡Œå†™äº†ä¸€ä¸ªé•¿é˜»å¡ï¼Œè¿™å¤ªç³Ÿäº†
        time.sleep(1)
        self.logger.info(f'job done:{job_id}')
```

æœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä»¥æå®šï¼Œä¸€ç§æ˜¯Tornadoæä¾›çš„è£…é¥°å™¨ï¼Œæœ‰ç‚¹å·æ‡’ä½†æ˜¯å¥½ç”¨ï¼Œ`run_on_executor`è£…é¥°å™¨å°†è‡ªåŠ¨åœ°æŠŠåŒæ­¥å‡½æ•°ï¼ˆ`do_something`ï¼‰æ”¾è¿› `self.executor`æ‰§è¡Œï¼Œå¹¶æŠŠå®ƒå°è£…æˆä¸€ä¸ª `async`å‡½æ•°ï¼ˆå…¶å®ç§°ä¸º `awaitable`å¯¹è±¡æ¯”è¾ƒå¥½ï¼‰

```python
from tornado.concurrent import run_on_executor
from concurrent.futures import ThreadPoolExecutor


class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()
    executor = ThreadPoolExecutor(20)

    async def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        await self.do_something(job_id)
        self.write(f"{job_id} done")

    # æ²¡å…³ç³»ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨executoré‡Œæ‰§è¡Œå°±å¥½äº†
    # æ³¨æ„ï¼šè¿™é‡Œæ”¹æˆäº†åŒæ­¥å‡½æ•°
    @run_on_executor
    def do_something(self, job_id):
        # å“¦ï¼Œè¿™ä¼šé˜»å¡æœåŠ¡å™¨ï¼
        time.sleep(1)
        self.logger.info(f'job done:{job_id}')
```

å¦ä¸€ç§æ˜¯å¸¸è§çš„å¼‚æ­¥å†™æ³•ï¼Œæ˜¯æ ‡å‡† `IOLoop`æ”¯æŒçš„

```python
from tornado import ioloop
from concurrent.futures import ThreadPoolExecutor
class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()
    executor = ThreadPoolExecutor(20)

    async def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        # æ²¡å…³ç³»ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨executoré‡Œæ‰§è¡Œå°±å¥½äº†
        await ioloop.IOLoop.current().run_in_executor(self.executor, self.do_something, job_id)
        self.write(f"{job_id} done")

     # æ³¨æ„ï¼šè¿™é‡Œæ”¹æˆäº†åŒæ­¥å‡½æ•°
    def do_something(self, job_id):
        # å“¦ï¼Œè¿™ä¼šé˜»å¡æœåŠ¡å™¨ï¼
        time.sleep(1)
        self.logger.info(f'job done:{job_id}')
```

å®è·µä¸­ï¼Œç”±äºGILé”é™åˆ¶ï¼Œçº¿ç¨‹å¹¶ä¸èƒ½å‘æŒ¥æœºå™¨åœ°å…¨éƒ¨å®åŠ›ï¼Œåœ¨CPUå¯†é›†æ—¶æ¨èå°† `ThreadPoolExecutor`æ”¹ä¸º `ProcessPoolExecutor`ï¼Œä½†æ˜¯ç”±äº `pickle`ä¸èƒ½å°è£…è‡ªå®šä¹‰ç±»å‘é€ç»™å­è¿›ç¨‹æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦æŠŠCPUå¯†é›†å‹æ“ä½œå•ç‹¬å†™æˆä¸€ä¸ªå‡½æ•°ï¼Œè¿™é‡Œç”¨ç¬¬äºŒç§æ–¹å¼åšç¤ºèŒƒï¼Œå› ä¸ºç¬¬äºŒç§æ–¹å¼æ›´é€šç”¨ï¼Œä¹Ÿæ›´å¥½å†™

```python
from concurrent.futures import ProcessPoolExecutor

def real_work():
    time.sleep(1)


class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()
    executor = ProcessPoolExecutor(20)

    async def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        await self.do_something(job_id)
        self.write(f"{job_id} done")

    async def do_something(self, job_id):
        #æ ¹æ®æœ€å°åŸåˆ™å°è£…
        await ioloop.IOLoop.current().run_in_executor(self.executor, real_work)
        self.logger.info(f'job done:{job_id}')
```

å¥½äº†ï¼Œç»è¿‡ä»¥ä¸Šæ“ä½œï¼Œæˆ‘ä»¬å·²ç»æ˜ç™½äº†å¦‚ä½•å°è£…åŒæ­¥ä¸ºå¼‚æ­¥ï¼ŒåŒ–è…æœ½ä¸ºç¥å¥‡ï¼Œæœ‰ä¸€ç‚¹åƒä¸‡è®°ä½ï¼Œ**åœ¨åç¨‹ä¸­ï¼Œä»»ä½•é˜»å¡éƒ½æœ‰å¯èƒ½æ˜¯è‡´å‘½çš„ï¼ä»»ä½•executorå°è£…çš„æ“ä½œéƒ½éœ€è¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼**

ä»¥åŠï¼Œä»”ç»†åˆ†æå‹åŠ›ç‚¹ï¼Œæ˜¯æµé‡é¡¶ä¸ä½è¿˜æ˜¯è®¡ç®—å¤ªæ…¢ï¼Œå¦‚æœæ˜¯å‰è€…ï¼Œå°±é‡‡ç”¨Tornadoå¤šè¿›ç¨‹æ¨¡å¼ï¼Œå¦‚æœæ˜¯åè€…ï¼Œå°±ä½¿ç”¨ `executor`æ‰¿å‹

æœ€åï¼Œ`executor`çš„æ‰¿è½½æ•°é‡æ˜¯æœ‰é™çš„ï¼Œä½ å¯ä»¥å°è¯•è°ƒå¤§æµ‹è¯•è„šæœ¬å¹¶å‘æ•°é‡ï¼Œçœ‹æ˜¯å¦è¿˜èƒ½ä¿æŒä¹‹å‰çš„æˆåŠŸç‡

```python
# æ€»è¯·æ±‚æ•°
REQUEST_NUM=3000
# 100å¹¶å‘
PROCESSOR_NUM=100
```

# ç©ºé—´æ¢æ—¶é—´ï¼šç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹

åœ¨ä¸Šä¸€ç« ä¸­ï¼Œå¦‚æœä½ ç¡®å®è°ƒå¤§äº†å¹¶å‘é‡å’Œè¯·æ±‚æ•°ï¼Œä½ å°±ä¼šå‘ç°ï¼Œåœ¨æœåŠ¡å™¨å¯ç”¨çº¿ç¨‹è¢«è€—å°½çš„æƒ…å†µä¸‹ï¼ˆå½“ç„¶ä½ å¯ä»¥è®¾ç½®å‡ ç™¾ä¸Šåƒä¸ªï¼‰ï¼Œä½ çš„è¿æ¥ä»ç„¶ä¼šå¤±è´¥ã€‚å…¶å®åœ¨ä»»ä½•webæ¡†æ¶ä¸­éƒ½æ˜¯ä¸€æ ·çš„ï¼Œèµ„æºè€—å°½å°±åªæœ‰æ­»è·¯ä¸€æ¡ã€‚å¯¹äºè¿™ç±»ä»»åŠ¡ï¼Œç¨‹åºå‘˜åº”è¯¥æå‰é¢„åˆ¤åˆ°ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå¼‚æ­¥ä»»åŠ¡ï¼Œåˆ©ç”¨ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚

æ¥ä¸‹æ¥æˆ‘å°†å±•ç¤ºä¸€ä¸ªå¼‚æ­¥æ¨¡å¼ä¸‹çš„æ¶ˆè´¹è€…æ¨¡å‹ï¼Œåˆ©ç”¨ `IOLoop.add_callback()`å‡½æ•°ï¼Œå°†æ¶ˆè´¹è€…çš„æ¶ˆè´¹å‡½æ•°æ³¨å†Œä¸ºä»»åŠ¡ï¼ŒåŒæ—¶ä¾é  `ThreadPoolExecutor`æ‰§è¡Œé˜»å¡æ“ä½œ

```python
async def async_period_job(func, period):
    while True:
        try:
            await func()
        except Exception as e:
            get_logger().exception(e)
        await asyncio.sleep(period)


# å®šæ—¶ä»»åŠ¡çš„å¸¸ç”¨å†™æ³•
start_period_job = functools.partial(ioloop.IOLoop.current().add_callback, async_period_job)


def sleep(t, job_id):
    # è€—æ—¶æ“ä½œ å…¼å®¹ProcessPoolExecutor
    # å¦‚æœä½¿ç”¨è‡ªå®šä¹‰çš„ORMç±»ï¼Œä½¿ç”¨ThreadPoolExecutorå°±è¶³å¤Ÿäº†ï¼Œä¸éœ€è¦å¤§è´¹å‘¨ç« å°†å…¶å†™æˆå¤–éƒ¨å‡½æ•°
    time.sleep(t)
    return job_id


class SimpleConsumer:
    def __init__(self):
        self.buffer = Queue()
        self.futures = Queue()
        self.started = False
        self.log = get_logger()
        # 2ç§’æ”¶é›†ä¸€æ¬¡ç»“æœ
        self.collect_period = 2
        # è¿™é‡Œæ§åˆ¶æ¶ˆè´¹è€…æ•°é‡
        self.executor = PoolExecutor(20)

    async def put(self, job_id):
        await self.buffer.put(job_id)

    async def real_work(self):
        # ç”±äºpickleçš„åŸå› ï¼Œä¸èƒ½æ”¾åœ¨executoré‡Œ
        data = await self.buffer.get()
        self.log.info(f'scheduling {data}')
        future = self.executor.submit(sleep, 1, data)
        return future, data

    def start(self):
        if self.started:
            return
        self.started = True
        self.log.info('Consumer Started!')
        ioloop.IOLoop.current().add_callback(self._start_real_work)
        start_period_job(self._collect, self.collect_period)

    async def _collect(self):
        # å®šæ—¶æ”¶é›†ç»“æœ
        not_done = Queue()
        while not self.futures.empty():
            future, data = await self.futures.get()
            if future.done():
                try:
                    result = future.result()
                    await self.collect_result(result)
                except Exception as e:
                    self.log.exception(e)
                    await self.buffer.put(data)  # retry
            else:
                await not_done.put((future, data))
        while not not_done.empty():
            await self.futures.put(await not_done.get())

    async def _start_real_work(self):
        while True:
            future, data = await self.real_work()
            await self.futures.put((future, data))

    async def collect_result(self, result):
        self.log.info(f'Collected job: {result}')


# æœ€ç®€å•çš„å•ä¾‹
consumer = SimpleConsumer()
consumer.start()


class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()
    consumer = consumer

    async def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        await self.do_something(job_id)
        self.write(f"{job_id} add")

    async def do_something(self, job_id):
        await self.consumer.put(job_id)
        self.logger.info(f'job add:{job_id}')
```

ä½¿ç”¨å¹¶å‘è„šæœ¬æµ‹è¯•ï¼Œå°†å¾—åˆ°ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—ï¼š

```bash
[I 211218 02:14:10 hello:112] job add:2
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 1.54ms
[I 211218 02:14:10 hello:112] job add:1
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 1.53ms
[I 211218 02:14:10 hello:112] job add:3
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 1.58ms
[I 211218 02:14:10 hello:112] job add:5
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 1.67ms
[I 211218 02:14:10 hello:112] job add:4
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 1.73ms
[I 211218 02:14:10 hello:112] job add:0
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 1.76ms
[I 211218 02:14:10 hello:59] scheduling 2
[I 211218 02:14:10 hello:59] scheduling 1
[I 211218 02:14:10 hello:59] scheduling 3
[I 211218 02:14:10 hello:59] scheduling 5
[I 211218 02:14:10 hello:59] scheduling 4
[I 211218 02:14:10 hello:59] scheduling 0
[I 211218 02:14:10 hello:112] job add:8
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 0.70ms
[I 211218 02:14:10 hello:112] job add:7
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 0.69ms
[I 211218 02:14:10 hello:112] job add:9
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 0.74ms
[I 211218 02:14:10 hello:59] scheduling 8
[I 211218 02:14:10 hello:59] scheduling 7
[I 211218 02:14:10 hello:59] scheduling 9
[I 211218 02:14:10 hello:112] job add:6
[I 211218 02:14:10 web:2239] 200 GET / (127.0.0.1) 1.15ms
[I 211218 02:14:10 hello:59] scheduling 6
[I 211218 02:14:13 hello:94] Collected job: 2
[I 211218 02:14:13 hello:94] Collected job: 1
[I 211218 02:14:13 hello:94] Collected job: 3
[I 211218 02:14:13 hello:94] Collected job: 5
[I 211218 02:14:13 hello:94] Collected job: 4
[I 211218 02:14:13 hello:94] Collected job: 0
[I 211218 02:14:13 hello:94] Collected job: 8
[I 211218 02:14:13 hello:94] Collected job: 7
[I 211218 02:14:13 hello:94] Collected job: 9
[I 211218 02:14:13 hello:94] Collected job: 6

```

æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œä»»åŠ¡åœ¨ä¸€è¾¹è¢«åŠ å…¥é˜Ÿåˆ—ï¼Œä¸€è¾¹è¿›è¡Œï¼Œå°±å¦‚æˆ‘å‰é¢æ‰€è¯´ï¼Œåç¨‹ä¼šåœ¨ `await`çš„æ—¶å€™é‡Šæ”¾CPUå¹¶åˆ‡æ¢åˆ°å‡†å¤‡å¥½çš„åç¨‹ç»§ç»­æ‰§è¡Œï¼Œè¿™é‡Œä½“ç°ä¸ºå¿™æ—¶ä¸€ç›´åœ¨æ¥æ”¶è¯·æ±‚ï¼Œé—²æ—¶å¯¹bufferé‡Œçš„å†…å®¹è¿›è¡Œå¤„ç†ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡Tornadoçš„å¤šè¿›ç¨‹æ¨¡å¼è½»æ¾æ‹“å±•ç”Ÿäº§è€…ï¼Œé€šè¿‡ç©ºé—´æ¢æ—¶é—´ï¼Œä¿è¯è¯·æ±‚ä¸ä¼šå¤±è´¥ï¼Œå°†ä»»åŠ¡è½»æ¾è½¬æ¢ä¸ºåå°ä»»åŠ¡ï¼Œé€šè¿‡æ§åˆ¶ `PoolExecutor`çš„ `worker`æ•°é‡ï¼Œæ§åˆ¶æ¶ˆè´¹è€…æ•°é‡ï¼Œè¾¾åˆ°æ€§èƒ½å¹³è¡¡

å’Œåˆšæ‰ç”¨ `ProcessPoolExecutor`ä¸€æ ·ï¼Œåœ¨CPUå¯†é›†çš„æƒ…å†µä¸‹ï¼Œå¤šè¿›ç¨‹æ¶ˆè´¹è€…æ˜¾ç„¶æ›´å…·ä¼˜åŠ¿

```python
from concurrent.futures import ProcessPoolExecutor as PoolExecutor
```

ç°åœ¨è¯·ä½ è¯•ç€åŠ å¤§æ€»è¯·æ±‚æ•°ï¼Œçœ‹çœ‹æ•ˆæœï¼Œä½ ä¼šå‘ç°åœ¨åŠ å…¥äº†é˜Ÿåˆ—ä¹‹åï¼Œå³ä½¿æ˜¯å•çº¿ç¨‹ä¹Ÿå¯ä»¥ç¬é—´æå®šæ‰€æœ‰è¯·æ±‚ï¼Œè¿™æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ç»™æˆ‘ä»¬å¸¦æ¥çš„ä¾¿åˆ©ã€‚

```bash
REQUEST_NUM = 1000
```

# æ€»ç»“

æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•åˆ©ç”¨Tornadoçš„å¼‚æ­¥ç‰¹æ€§ï¼Œæ‰“é€ é«˜æ€§èƒ½TornadoæœåŠ¡å™¨ï¼Œæœ‰å‡ ç‚¹éœ€è¦è¯¾åå¤ä¹ 

1. è‡ªåº•å‘ä¸Šçš„å¼‚æ­¥æ”¹é€ 
2. ä½¿ç”¨ `executor`å°è£…å¼‚æ­¥æ“ä½œ
3. ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹çš„å¼‚æ­¥å®ç°

è¿˜æœ‰å‡ ç‚¹éœ€è¦é¢å¤–æ³¨æ„ï¼š

1. ä½¿ç”¨ `executor`æ—¶çš„çº¿ç¨‹å®‰å…¨é—®é¢˜
2. `ProcessPoolExecutor`çš„ `pickle`é—®é¢˜
3. `executor`æ˜¯æœ‰å¹¶è¡Œæ•°é‡é™åˆ¶çš„

# é™„å½•

ç”Ÿäº§è€…æ¶ˆè´¹è€…å®Œæ•´ä»£ç 

```python
import asyncio
import functools
import logging
import time
from asyncio import Queue
from concurrent.futures import ThreadPoolExecutor as PoolExecutor

import tornado.httpserver
import tornado.ioloop
import tornado.options
import tornado.web
import json

from tornado import ioloop
from tornado.concurrent import run_on_executor
from tornado.options import define, options

define("port", default=8888, help="run on the given port", type=int)


def get_logger():
    return logging.getLogger('tornado.general')


async def async_period_job(func, period):
    while True:
        try:
            await func()
        except Exception as e:
            get_logger().exception(e)
        await asyncio.sleep(period)


# å®šæ—¶ä»»åŠ¡çš„å¸¸ç”¨å†™æ³•
start_period_job = functools.partial(ioloop.IOLoop.current().add_callback, async_period_job)


def sleep(t, job_id):
    # è€—æ—¶æ“ä½œ å…¼å®¹ProcessPoolExecutor
    # å¦‚æœä½¿ç”¨è‡ªå®šä¹‰çš„ORMç±»ï¼Œä½¿ç”¨ThreadPoolExecutorå°±è¶³å¤Ÿäº†ï¼Œä¸éœ€è¦å¤§è´¹å‘¨ç« å°†å…¶å†™æˆå¤–éƒ¨å‡½æ•°
    time.sleep(t)
    return job_id


class SimpleConsumer:
    def __init__(self):
        self.buffer = Queue()
        self.futures = Queue()
        self.started = False
        self.log = get_logger()
        self.collect_period = 2
        self.executor = PoolExecutor(20)

    async def put(self, job_id):
        await self.buffer.put(job_id)

    async def real_work(self):
        data = await self.buffer.get()
        self.log.info(f'scheduling {data}')
        future = self.executor.submit(sleep, 1, data)
        return future, data

    def start(self):
        if self.started:
            return
        self.started = True
        self.log.info('Consumer Started!')
        ioloop.IOLoop.current().add_callback(self._start_real_work)
        start_period_job(self._collect, self.collect_period)

    async def _collect(self):
        # æ”¶é›†ç»“æœï¼Œåº”å½“åœ¨å®šæ—¶ä»»åŠ¡é‡Œé¢åš
        not_done = Queue()
        while not self.futures.empty():
            future, data = await self.futures.get()
            if future.done():
                try:
                    result = future.result()
                    await self.collect_result(result)
                except Exception as e:
                    self.log.exception(e)
                    await self.buffer.put(data)  # retry
            else:
                await not_done.put((future, data))
        while not not_done.empty():
            await self.futures.put(await not_done.get())

    async def _start_real_work(self):
        while True:
            future, data = await self.real_work()
            await self.futures.put((future, data))

    async def collect_result(self, result):
        self.log.info(f'Collected job: {result}')


consumer = SimpleConsumer()
consumer.start()


class MainHandler(tornado.web.RequestHandler):
    logger = get_logger()
    consumer = consumer

    async def get(self):
        job_id = json.loads(self.request.body.decode()).get('job_id')
        await self.do_something(job_id)
        self.write(f"{job_id} add")

    async def do_something(self, job_id):
        await self.consumer.put(job_id)
        self.logger.info(f'job add:{job_id}')


def main():
    tornado.options.parse_command_line()
    application = tornado.web.Application([(r"/", MainHandler)])
    http_server = tornado.httpserver.HTTPServer(application)
    http_server.listen(options.port)
    # http_server.start(0)
    tornado.ioloop.IOLoop.current().start()


if __name__ == "__main__":
    main()

```

æµ‹è¯•è„šæœ¬ä»£ç 

```python
import requests
import json
from multiprocessing import Pool

from requests import Timeout

REQUEST_NUM = 1000
PROCESSOR_NUM = 10


def api_request(job_id):
    try:
        response = requests.get('http://localhost:8888', data=json.dumps({'job_id': job_id}), timeout=3)
    except Timeout:
        return False
    return response.status_code == 200


if __name__ == '__main__':
    with Pool(PROCESSOR_NUM) as p:
        result = p.map(api_request, range(REQUEST_NUM))
    succeed = result.count(True)
    failed = result.count(False)
    print(f"{succeed / (failed + succeed) * 100}% request success!")

```
