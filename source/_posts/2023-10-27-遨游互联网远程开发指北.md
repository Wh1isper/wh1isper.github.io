---
layout:     post                    # ä½¿ç”¨çš„å¸ƒå±€ï¼ˆä¸éœ€è¦æ”¹ï¼‰
title:      ğŸš€é¨æ¸¸äº’è”ç½‘è¿œç¨‹å¼€å‘æŒ‡åŒ—	# æ ‡é¢˜ 
subtitle:   é¨æ¸¸äº’è”ç½‘è¿œç¨‹å¼€å‘æŒ‡åŒ— 	 #å‰¯æ ‡é¢˜
date:       2023-10-27              # æ—¶é—´
author:     Wh1isper                      # ä½œè€…
banner_img: /img/post-bg-coffee.jpeg    #æŠ€æœ¯åˆ†äº«-ç¼–ç¨‹
catalog: true                       # æ˜¯å¦å½’æ¡£
tags:                               #æ ‡ç­¾
    - å¼€æº
    - å†…ç½‘ç©¿é€
category:
    # - éšç¬”
    # - æ—¶è¯„
    # - è¯»ä¹¦ç¬”è®°
    - æŠ€æœ¯åˆ†äº«
---

# TLDR

ç”¨ä¸€ä¸ªåŸŸåå®ç°å…¬ç½‘ipv6ç›´è¿ã€å…¬ç½‘ipv4ç©¿é€ã€å†…ç½‘ç›´è¿è®¿é—®

> æ­¤æ•™ç¨‹å¹¶éé€šç”¨æ•™ç¨‹ï¼Œå¯å‚è€ƒä¿®æ”¹

![ç½‘ç»œæ‹“æ‰‘å›¾](../img/2023-10-27-é¨æ¸¸äº’è”ç½‘è¿œç¨‹å¼€å‘æŒ‡åŒ—/remote-develop.png)

# æ¡ˆä¾‹ä¸æ•ˆæœå±•ç¤º

å†…ç½‘ç”¨æˆ·è®¿é—®`yourdomain`ï¼Œå¯ä»¥ç›´æ¥è®¿é—®åˆ°å†…ç½‘æœºå™¨

```bash
$ curl -v https://wh1isper.top:8080
*   Trying [::ffff:192.168.31.254]:8080...
* Connected to wh1isper.top (::ffff:192.168.31.254) port 8080
```

å¤–ç½‘ipv6ç”¨æˆ·è®¿é—®`yourdomain`ï¼Œå¯ä»¥é€šè¿‡ipv6å…¬ç½‘åœ°å€ç›´è¿

```bash
$ curl -v https://wh1isper.top:8080
*   Trying [2408:8256:3284:1522::905]:8080...
* Connected to wh1isper.top (2408:8256:3284:1522::905) port 8080 (#0)
```

å¤–ç½‘ipv4ç”¨æˆ·è®¿é—®`yourdomain`ï¼Œå¯ä»¥é€šè¿‡è·³æ¿æœºè®¿é—®

```bash
$ nslookup wh1isper.top
curl -v https://wh1isper.top:8080
*   Trying 42.193.219.110:8080...
Connected to wh1isper.top (42.193.219.110) port 8080 (#0)
```

## æ¡ˆä¾‹ï¼šéƒ¨ç½²ä¸€ä¸ªcodeserver

`yay code-server`ï¼Œå®‰è£…`aur/code-server-marketplace`å’Œ`aur/code-server`

æ ¹æ®æ–‡æ¡£é…ç½®è¯ä¹¦ã€å¯†ç ç­‰ï¼šhttps://github.com/coder/code-server

è¯ä¹¦å¯ä»¥åœ¨åŸŸåæœåŠ¡å•†ç”³è¯·ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…è´¹çš„letsencryptï¼Œæœ¬æ•™ç¨‹ä¸åŒ…å«ç›¸å…³å†…å®¹

`~/.config/code-server/config.yaml`

```
host: "::"
port: 2443
auth: password
password: 
cert: /path/to/cert/xxx.crt
cert-key: /path/to/cert/xxx.key
```

ç„¶åå°†2443ç«¯å£æ˜ å°„åˆ°è·³æ¿æœºçš„2443ç«¯å£

```ini
[FRP-CODE-SERVER]
type = tcp
local_ip = 127.0.0.1
local_port = 2443
remote_port = 2443
```

> ç›®å‰ï¼ŒHTTPS+TCPè·³æ¿çš„æ–¹å¼å¯ä»¥ç»•è¿‡è…¾è®¯äº‘åŸŸåå¤‡æ¡ˆæ£€æµ‹ï¼Œå¯ä»¥ä½¿ç”¨è…¾è®¯äº‘çš„æœåŠ¡å™¨ï¼Œå¦åˆ™å¯èƒ½éœ€è¦å¢ƒå¤–æœåŠ¡å™¨ä»¥ç»•è¿‡å¤‡æ¡ˆï¼Œæˆ–è€…è¿›è¡Œå¤‡æ¡ˆ

![æ•ˆæœå›¾](../img/2023-10-27-é¨æ¸¸äº’è”ç½‘è¿œç¨‹å¼€å‘æŒ‡åŒ—/code-server.png)


# åœºæ™¯è¯´æ˜

- å®¶åº­å®½å¸¦æä¾›ipv6å…¬ç½‘åœ°å€ï¼Œä½†æ˜¯æ²¡æœ‰ipv4å…¬ç½‘åœ°å€
    - å¤§éƒ¨åˆ†çœä»½çš„å®¶åº­å®½å¸¦éƒ½æœ‰è¿™é¡¹åŠŸèƒ½ï¼Œä¸€èˆ¬è€Œè¨€ï¼Œå¼€å‘æœºå™¨è·å¾—å…¬ç½‘ipv6åœ°å€å¯ä»¥é€šè¿‡è®¾ç½®å…‰çŒ«ä¸ºæ¡¥æ¥æ¨¡å¼ï¼Œè·¯ç”±å™¨æ‹¨å·ï¼Œç„¶åå†è·¯ç”±å™¨ipv6å¤„ä½¿ç”¨DHCPv6åè®®è·å–å…¬ç½‘ipv6åœ°å€
    - å¤§éƒ¨åˆ†çœä»½æ‰‹æœºæµé‡å·²ç»æ”¯æŒipv6ï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨å¤–æ—¶å¯ä»¥ä½¿ç”¨æ‰‹æœºæµé‡ç›´è¿æœºå™¨ï¼Œè·å–æ»¡å¸¦å®½
- æœ‰ä¸€å°å…·æœ‰å…¬ç½‘ipv4åœ°å€çš„æœåŠ¡å™¨ï¼Œä½œä¸ºå†…ç½‘ç©¿é€è·³æ¿æœº
- å®¶åº­ä½¿ç”¨çš„è·¯ç”±å™¨å¯ä»¥è®¾ç½®dhcpåœ°å€ç»‘å®šå’Œé™æ€åŸŸåè§£æ
    - è¿™ä½¿å¾—åœ¨å®¶ä½¿ç”¨æ—¶ï¼Œå¯ä»¥é€šè¿‡åŸŸåç›´æ¥è®¿é—®å†…ç½‘æœºå™¨ã€‚dhcpåœ°å€ç»‘å®šæ˜¯å¯é€‰çš„ï¼Œä½ ä¹Ÿå¯ä»¥é™æ€åˆ†é…ip
    - ä»¥çº¢ç±³è·¯ç”±å™¨ä¸ºä¾‹ï¼Œå¯ä»¥ç ´è§£è¿›å…¥sshé…ç½®é™æ€åŸŸåè§£æ
    - å¦‚æœæœ‰Clashç­‰è½¯è·¯ç”±ï¼Œä¸€èˆ¬éƒ½æ”¯æŒé™æ€åŸŸåè§£æï¼Œç”šè‡³å¯ä»¥è‡ªåŠ¨åšä¼˜é€‰
- ä¸€ä¸ªåŸŸåï¼Œé€‰ä½ å–œæ¬¢çš„å³å¯

# é‡ç‚¹é—®é¢˜

## å¦‚ä½•å°†å¼€å‘æœºçš„ipv6åœ°å€è¿›è¡Œç»‘å®š

éš¾ç‚¹ï¼š ç”±äºipv6åœ°å€æ˜¯åŠ¨æ€åˆ†é…çš„ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªæœºåˆ¶å°†ipv6åœ°å€ç»‘å®šåˆ°åŸŸåä¸Šï¼Œæ¯æ¬¡å˜åŠ¨ååˆ·æ–°ï¼ˆå³DDNSï¼‰ã€‚å¦‚æœæœ‰ä»»ä½•DDNSçš„æœåŠ¡å•†ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å…¶æä¾›çš„APIè¿›è¡Œç»‘å®šï¼Œå¦‚æœæ²¡æœ‰ï¼Œå¯ä»¥ä½¿ç”¨è„šæœ¬è¿›è¡Œç»‘å®šã€‚

è¿™é‡Œä»¥dnspodï¼ˆè…¾è®¯äº‘dnsï¼‰ä¸ºä¾‹ï¼Œç»™å‡ºä½¿ç”¨å…¶APIçš„åœ°å€ç»‘å®šæ–¹æ¡ˆè„šæœ¬

```python
import socket
import sys
import smtplib
import subprocess
import time
import urllib.request
from email.header import Header
from email.mime.text import MIMEText

import os
from tencentcloud.common import credential
from tencentcloud.common.exception.tencent_cloud_sdk_exception import (
    TencentCloudSDKException,
)

from tencentcloud.dnspod.v20210323 import dnspod_client, models

# ä¸ºäº†ä¿æŠ¤å¯†é’¥å®‰å…¨ï¼Œå»ºè®®å°†å¯†é’¥è®¾ç½®åœ¨ç¯å¢ƒå˜é‡ä¸­æˆ–è€…é…ç½®æ–‡ä»¶ä¸­ï¼Œè¯·å‚è€ƒæœ¬æ–‡å‡­è¯ç®¡ç†ç« èŠ‚ã€‚
# ç¡¬ç¼–ç å¯†é’¥åˆ°ä»£ç ä¸­æœ‰å¯èƒ½éšä»£ç æ³„éœ²è€Œæš´éœ²ï¼Œæœ‰å®‰å…¨éšæ‚£ï¼Œå¹¶ä¸æ¨èã€‚
# cred = credential.Credential("secretId", "secretKey")
cred = credential.Credential(
    os.environ.get("TENCENTCLOUD_SECRET_ID", ""),
    os.environ.get("TENCENTCLOUD_SECRET_KEY", ""),
)
# DOMAIN = "example.com" æ˜¯ä½ æ³¨å†Œçš„åŸŸå
DOMAIN = os.environ.get("DOMAIN", "")
client = dnspod_client.DnspodClient(cred, "ap-guangzhou")


cmd = "ifconfig"
encoding = "utf-8"
splitter = "inet6"

import socket


def isNetOK(testserver):
    s = socket.socket()
    s.settimeout(3)
    try:
        status = s.connect_ex(testserver)
        if status == 0:
            s.close()
            return True
        else:
            return False
    except Exception as e:
        return False

def isNetChainOK(testserver=("www.baidu.com", 443)):
    isOK = isNetOK(testserver)
    return isOK

def ddns_refresh(v6_address):
    for addr in v6_address:
        if "::" not in addr:
            continue
        print(f"refreshing ddns '{addr}'")

        m = models.DescribeRecordListRequest()
        m.Domain = DOMAIN
        records = client.DescribeRecordList(m)
        for record in records.RecordList:
            # remove all records
            if record.Type == "AAAA":
                req = models.DeleteRecordRequest()
                req.Domain = DOMAIN
                req.RecordId = record.RecordId
                client.DeleteRecord(req)

        # add new record for addr
        req = models.CreateRecordRequest()
        req.Domain = DOMAIN
        req.RecordType = "AAAA"
        req.Value = addr
        req.RecordLine = "é»˜è®¤"

        resp = client.CreateRecord(req)
        print(resp.to_json_string())


def get_v6_address():
    cmd_output = subprocess.run(cmd, capture_output=True).stdout.decode(encoding)
    v6_address = set()
    for line in cmd_output.splitlines():
        if splitter in line and "fe80" not in line:
            addr = line.split(splitter)[1].strip()
            addr = addr.split("/64")[0]
            if addr == "::1":
                continue
            v6_address.add(addr)
    return v6_address


def set_to_str(sets):
    return "\n".join(sets)


if __name__ == "__main__":
    while not isNetChainOK():
        time.sleep(10)
        print("No network connection, waiting...")
    v6_address = get_v6_address()
    ddns_refresh(v6_address)
    for e in send_list:
    print("è®¾å¤‡è”ç½‘ï¼Œå¼€å§‹ç›‘æµ‹V6åœ°å€")
    while True:
        time.sleep(60)
        new_v6_address = get_v6_address()
        if isNetChainOK() and new_v6_address and new_v6_address != v6_address:
            try:
                ddns_refresh(new_v6_address)
            except Exception as e:
                print(e)
                print("error refreshing ddns...")
            v6_address = new_v6_address
```


## é…ç½®frp

æˆ‘ä»¬ä½¿ç”¨[frp](https://github.com/fatedier/frp)ä¸ºä¾‹

éœ€è¦ä¸‹è½½frpçš„releaseï¼Œç„¶åå°†frpså’Œfrpcæ”¾åˆ°`/usr/bin`ç›®å½•ä¸‹ï¼ˆå…¶ä»–ç›®å½•ä¹Ÿéƒ½å¯ä»¥ï¼Œæ³¨æ„ä¸€ä¼šsystemdé…ç½®é‡Œé¢æ‰§è¡Œå‘½ä»¤å’Œç›¸å¯¹åº”é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼‰

é…ç½®systemdæœåŠ¡ï¼Œåˆ†åˆ«æ”¾åˆ°`/etc/systemd/system/frps.service`å’Œ`/etc/systemd/system/frpc.service`ä¸­ã€‚(ä¸€è¯´æ”¾åœ¨`/usr/lib/systemd/system/`ä¸‹ä¹Ÿå¯ä»¥)ã€‚è·³æ¿æœºåªéœ€è¦é…ç½®frpsï¼Œå¼€å‘æœºé…ç½®frpc

`frps.service`è·³æ¿æœºä½¿ç”¨rootï¼Œè¿™æ ·å¯ä»¥ç»‘å®šä½ç«¯å£

```ini
[Unit]
Description=Frp Server Service
After=network.target

[Service]
Type=simple
User=root
Restart=on-failure
RestartSec=5s
ExecStart=/usr/bin/frps -c /etc/frp/frps.ini
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
```

`frpc.service`å¼€å‘æœºé…ç½®

```ini
[Unit]
Description=Frp Client Service
After=network.target

[Service]
Type=simple
User=nobody
Restart=always
RestartSec=5s
ExecStart=/usr/bin/frpc -c /etc/frp/frpc.ini
ExecReload=/usr/bin/frpc reload -c /etc/frp/frpc.ini
LimitNOFILE=1048576

[Install]
WantedBy=multi-user.target
```

æ¥ç€æˆ‘ä»¬é…ç½®frpçš„é…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«æ”¾åˆ°`/etc/frp/frps.ini`å’Œ`/etc/frp/frpc.ini`ä¸­

è·³æ¿æœºé…ç½®`/etc/frp/frps.ini`

```ini
[common]
# frpæœåŠ¡ç«¯å£å’Œå¯†ç 
bind_port = 7000
token = 


# frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹
dashboard_port = 7500
# frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„
dashboard_user = 
dashboard_pwd = 
enable_prometheus = true


# frpæ—¥å¿—é…ç½®
log_file = /var/log/frps.log
log_level = info
log_max_days = 3
```

å¼€å‘æœºé…ç½®`/etc/frp/frpc.ini`

```ini
[common]
# ä½ çš„è·³æ¿æœºçš„ipåœ°å€
server_addr = 
# ä½ çš„è·³æ¿æœºçš„frpæœåŠ¡ç«¯å£
server_port = 7000
# frpæœåŠ¡å¯†ç 
token = 

# æ¡ˆä¾‹ï¼šå°†æœ¬åœ°çš„22ç«¯å£æ˜ å°„åˆ°è·³æ¿æœºçš„2222ç«¯å£
# åˆ›å»ºä¸€ä¸ªå«FRP-SSHçš„tcpéš§é“ï¼Œå°†æœ¬åœ°çš„22ç«¯å£æ˜ å°„åˆ°è·³æ¿æœºçš„2222ç«¯å£
[FRP-SSH]
type = tcp
local_ip = 127.0.0.1
local_port = 22
remote_port = 2222
```

åœ¨å®é™…ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¼€å‘æœºçš„SSHç«¯å£ä¹Ÿæ”¹ä¸º2222ï¼ˆç›¸åº”ï¼Œä¸Šé¢çš„`local_port`åº”è¯¥ä¸º2222ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥ä½¿ç”¨`ssh -p 2222 user@yourdomain`ç»Ÿä¸€è¿æ¥äº†


## å†…ç½‘åœ°å€è§£æ

ä»¥shellclashä¸ºä¾‹ï¼Œç ´è§£äº†sshçš„çº¢ç±³è·¯ç”±å™¨å¯ä»¥ç›´æ¥å®‰è£…shellclashï¼Œå³å¯å®ç°è½¯è·¯ç”±ï¼ˆç§‘å­¦ä¸Šç½‘ä¸åœ¨æœ¬æ•™ç¨‹å†…ï¼‰

ç„¶ååœ¨shellclashçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®

è¿™ä¸ªæ˜¯æŸä¸ªç”¨æˆ·æ–‡ä»¶çš„åœ°å€ï¼Œå¯ä»¥é€šè¿‡ç”¨æˆ·è‡ªå®šä¹‰æ–‡ä»¶çš„é«˜çº§åŠŸèƒ½çœ‹åˆ°ç›®å‰çš„è‡ªå®šä¹‰æ–‡ä»¶åœ°å€

`/userdisk/clash/yamls/user.yaml`

```yaml

hosts:
  'yourdomain': 192.168.x.x
```

å¦‚æœä¸ä½¿ç”¨clashçš„dnsï¼Œä¸€ç§æ–¹å¼æ˜¯åœ¨hostsæ–‡ä»¶(`/etc/hosts`)é‡Œé…ç½®

```bash
192.168.x.x yourdomain
```